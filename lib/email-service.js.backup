import dotenv from "dotenv";
dotenv.config();
import { Resend } from 'resend'

console.log('ğŸ“§ Email Service Loading...')
console.log('RESEND_API_KEY on load:', process.env.RESEND_API_KEY ? 'Present' : 'Missing')

const resend = new Resend(process.env.RESEND_API_KEY)

// ... (keep the existing sendPasswordResetEmail function) ...

// Direct fetch implementation as fallback
async function sendEmailDirectFetch(email, name, type = 'welcome') {
  try {
    console.log('ğŸ”„ Trying direct fetch method...')
    
    const subject = type === 'welcome' 
      ? `Welcome to EmpowerAbility, ${name}! ğŸ‰`
      : 'Reset Your Password - EmpowerAbility'
    
    const htmlContent = type === 'welcome' 
      ? `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
           <div style="background: #667eea; color: white; padding: 30px; text-align: center;">
             <h1>Welcome to EmpowerAbility! ğŸ‰</h1>
           </div>
           <div style="background: #f9f9f9; padding: 30px;">
             <h2>Hello ${name}!</h2>
             <p>Welcome to our community! We're excited to have you join us.</p>
             <p>Start exploring features and connecting with others.</p>
             <p>Best regards,<br><strong>The EmpowerAbility Team</strong></p>
           </div>
         </div>`
      : ''; // Add password reset template if needed

    const response = await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.RESEND_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        from: process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev',
        to: email,
        subject: subject,
        html: htmlContent,
      }),
    })

    if (!response.ok) {
      const errorData = await response.json()
      throw new Error(errorData.message || `HTTP ${response.status}`)
    }

    const data = await response.json()
    console.log('âœ… Direct fetch email sent successfully! ID:', data.id)
    return { success: true, data }
  } catch (error) {
    console.log('âŒ Direct fetch failed:', error.message)
    return { success: false, error }
  }
}

export async function sendWelcomeEmail(email, name) {
  console.log('ğŸ” DEBUG - Resend API Key present:', !!process.env.RESEND_API_KEY);
  console.log('ğŸ” DEBUG - From email:', process.env.RESEND_FROM_EMAIL);
  console.log('ğŸ” DEBUG - NEXTAUTH_URL:', process.env.NEXTAUTH_URL);
  const maxRetries = 3;
  let lastError = null;
  console.log("ğŸ” DEBUG - In sendWelcomeEmail function");
  console.log("ğŸ” DEBUG - Resend API Key:", !!process.env.RESEND_API_KEY);
  console.log("ğŸ” DEBUG - From email:", process.env.RESEND_FROM_EMAIL);
  console.log("ğŸ” DEBUG - Email:", email);
  console.log("ğŸ” DEBUG - Name:", name);

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
  console.log('ğŸ” DEBUG - Resend API Key present:', !!process.env.RESEND_API_KEY);
  console.log('ğŸ” DEBUG - From email:', process.env.RESEND_FROM_EMAIL);
  console.log('ğŸ” DEBUG - NEXTAUTH_URL:', process.env.NEXTAUTH_URL);
    try {
      console.log(' ')
      console.log(`ğŸ‰ === WELCOME EMAIL (Attempt ${attempt}/${maxRetries}) ===`)
      console.log('To:', email)
      console.log('Name:', name)
      
      // Try Resend SDK first
      const htmlTemplate = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <div style="background: #667eea; color: white; padding: 30px; text-align: center;">
            <h1>Welcome to EmpowerAbility! ğŸ‰</h1>
            <p>We're thrilled to have you join our community</p>
          </div>
          <div style="background: #f9f9f9; padding: 30px;">
            <h2>Hello ${name}!</h2>
            <p>Welcome to EmpowerAbility - your platform for connecting, sharing, and growing together.</p>
            
            <h3>ğŸš€ Quick Start</h3>
            <ul>
              <li>Complete your profile</li>
              <li>Explore communities</li>
              <li>Share your experiences</li>
            </ul>

            <div style="text-align: center; margin: 20px 0;">
              <a href="${process.env.NEXTAUTH_URL || 'https://905310e12cd426dc20677303fb187b0a.serveo.net'}" 
                 style="background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;">
                Start Exploring
              </a>
            </div>

            <p>Best regards,<br><strong>The EmpowerAbility Team</strong></p>
          </div>
        </div>
      `;

      const textTemplate = `Welcome to EmpowerAbility, ${name}! ğŸ‰`;

      const { data, error } = await resend.emails.send({
        from: process.env.RESEND_FROM_EMAIL || 'onboarding@resend.dev',
        to: email,
        subject: `Welcome to EmpowerAbility, ${name}! ğŸ‰`,
        html: htmlTemplate,
        text: textTemplate
      })

      if (error) {
        lastError = error;
        console.log(`âŒ Resend SDK attempt ${attempt} failed:`, error.message)
        
        // Try direct fetch as fallback
        if (attempt === 2) {
          console.log('ğŸ”„ Switching to direct fetch method...')
          const directResult = await sendEmailDirectFetch(email, name, 'welcome')
          if (directResult.success) {
            return directResult
          }
        }
        
        if (attempt < maxRetries) {
          const delay = attempt * 2000; // 2s, 4s delays
          console.log(`ğŸ”„ Retrying in ${delay/1000} seconds...`)
          await new Promise(resolve => setTimeout(resolve, delay));
          continue;
        }
        
        console.log('=== WELCOME EMAIL END (FAILED) ===')
        return { success: false, error: lastError }
      }

      console.log('âœ… Welcome email sent successfully! ID:', data.id)
      console.log('=== WELCOME EMAIL END (SUCCESS) ===')
      return { success: true, data }
      
    } catch (error) {
      lastError = error;
      console.log(`âŒ Welcome email attempt ${attempt} error:`, error.message)
      
      // Try direct fetch as fallback
      if (attempt === 2) {
        console.log('ğŸ”„ Switching to direct fetch method...')
        const directResult = await sendEmailDirectFetch(email, name, 'welcome')
        if (directResult.success) {
          return directResult
        }
      }
      
      if (attempt < maxRetries) {
        const delay = attempt * 2000;
        console.log(`ğŸ”„ Retrying in ${delay/1000} seconds...`)
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      
      console.log('=== WELCOME EMAIL END (ERROR) ===')
      return { success: false, error: lastError }
    }
  }
}

// Test network connectivity
export async function testNetwork() {
  console.log('ğŸŒ Testing network connectivity...')
  
  try {
    // Test DNS resolution
    const dnsResponse = await fetch('https://dns.google/resolve?name=api.resend.com&type=A')
    if (dnsResponse.ok) {
      console.log('âœ… DNS resolution working')
    }
    
    // Test API connectivity
    const apiResponse = await fetch('https://api.resend.com', { method: 'HEAD' })
    console.log('ğŸŒ Resend API reachable:', apiResponse.ok)
    
    return { dns: dnsResponse.ok, api: apiResponse.ok }
  } catch (error) {
    console.log('âŒ Network test failed:', error.message)
    return { dns: false, api: false, error: error.message }
  }
}

export async function sendPasswordResetEmail(email, resetLink) {
  try {
    console.log('ğŸ“§ Sending password reset email to:', email)
    console.log('ğŸ”— Reset link:', resetLink)
    
    // For now, just log the email (you can implement actual email sending later)
    console.log('âœ… Password reset email would be sent to:', email)
    console.log('ğŸ“ Reset link:', resetLink)
    
    return { success: true, message: 'Password reset email sent successfully' }
  } catch (error) {
    console.error('âŒ Error sending password reset email:', error)
    return { success: false, error: error.message }
  }
}
